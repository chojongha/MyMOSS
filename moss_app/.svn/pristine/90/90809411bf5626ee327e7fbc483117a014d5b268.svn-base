package com.kt.moss;

import android.app.Activity;
import android.app.NotificationManager;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.Window;
import android.view.WindowManager;
import android.widget.Button;
import android.widget.TextView;

public class PushPopupActivity extends Activity {

	private static final String TAG = "PushPopupActivity";
	public static Activity myActivity = null;
	
	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		
		//	현재 액티비티를 다른 액티비티에서 종료하기 위해 static 변수에 액티비티를 담아둔다.
		myActivity = PushPopupActivity.this;
		
		// 화면의 TitleBar, StatusBar 없애기
		requestWindowFeature(Window.FEATURE_NO_TITLE);
		getWindow().setFlags(WindowManager.LayoutParams.FLAG_FULLSCREEN, WindowManager.LayoutParams.FLAG_FULLSCREEN);
		
		setContentView(R.layout.pushpopup);
        // 화면이 잠겨있을 때 보여주기... 키잠금 해제, 화면 켜기
	    getWindow().addFlags(WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED | WindowManager.LayoutParams.FLAG_DISMISS_KEYGUARD | WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON);

	    // 텍스트뷰에 푸시 알람 내용 출력
	    TextView tvTital = (TextView)findViewById(R.id.tvTital);
	    String title = getIntent().getStringExtra("pushType");
        // 상황에 따른 타이블과 알림음 발생
        if("1".equals(title)) {
        	tvTital.setText("고장상황 발생");
        }
        else if("2".equals(title)) {
        	tvTital.setText("고장상황 진행");
        }
        else if("3".equals(title)) {
        	tvTital.setText("고장상황 회복");
        }
        else if("4".equals(title)) {
        	tvTital.setText("고장상황 수정");
        }
        else {
        	tvTital.setText("KT MOSS");
        }
        
	    TextView tvContents = (TextView)findViewById(R.id.tvContents);
	    tvContents.setText(getIntent().getStringExtra("message"));

	    //	GCMIntentService의 Context를 사용한다.
	    final Context context = GCMIntentService.myContext;
	    
	    // 버튼 이벤트
	    Button btnYes = (Button)findViewById(R.id.btnYes);
	    btnYes.setOnClickListener(new OnClickListener() {
	        @Override
	        public void onClick(View v) {
	            // 확인버튼을 누르면 앱의 런처액티비티를 호출한다.
	            Intent intent = new Intent(context, MainActivity.class).setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_SINGLE_TOP);
	            NotificationManager nm = (NotificationManager)getSystemService(NOTIFICATION_SERVICE);
	            
	            String msg = getIntent().getStringExtra("message");
	            int notiId = getIntent().getIntExtra("notiId", 0);
	            
	            Log.i(TAG, msg);
	            Log.i(TAG, String.valueOf(notiId));
	            // 현재 도착한 noti를 상태바에서 삭제
	            nm.cancel(notiId);
	            
	            startActivity(intent);
	            finish();
	        }
	    });
	    
	    Button btnNo = (Button)findViewById(R.id.btnNo);
	    btnNo.setOnClickListener(new OnClickListener() {
	        @Override
	        public void onClick(View v) {
	            finish();
	        }
	    });
	}
}
