var transOfficeDetail_debugPrefix = "[transOffice_detail.js] : "; 
var workplaceSN="";
var officeAddr="";
var mapOfficeName="";

function ifNull(data) {	
	//	문자열로 변환하여 비교
	data = String(data);
	
	if(data == null || data == "" || data == "null") {
		return "";
	} else {
		return data;
	}
}

var showTransCnt = 0;
//국사 상세 페이지 출력
function showTransOffice_detail(){
//	$.mobile.loading( "show", {
//        text: "로딩중...",
//        textVisible: true,
//        theme: "a",
//        html: "" 
//	}); 
	
	//국사 시퀀스 넘버 받기
	workplaceSN=Request("workplaceSeqNum");
	
	console.log(transOfficeDetail_debugPrefix + "넘어온 시퀀스넘버 = " + workplaceSN);
	
	$.ajax({ 
		url: url + "MossWorkplaceDetail",
		type: "post",
		timeout: 10*1000,
		dataType: "json",
		data: {workplaceSeqNum:workplaceSN},		
		success: function(result){
			var bodyData = result.body;
			var headerData = result.header;
			var transOfficeTB = "";
			
			if(headerData.result != 0){
				transOfficeTB = "<li data-icon='false'> "+
								"<a href='#'>" +
								"<center><h2>정보가 없습니다</h2></center>" +     
								"</a>" +
								"</li>";
//				$.mobile.hidePageLoadingMsg();
			}else{
				$.each(bodyData, function(key, val){
					$.each(val, function(key, val) {
	                    console.log(transOfficeDetail_debugPrefix + key + " : " + val);
	                });	
								
					//데이터 세팅
					var i=val.WORKPLACETYPE;																
					officeAddr = val.ADDR + " " + val.ADDRDTL;
					mapOfficeName = val.WORKPLACENAME;
					
					//테이블 생성
					transOfficeTB = '<table>'+
									'<tr>'+									
									'</tr>'+
									'<tr>'+
									'<td align="left" colspan="2" bgcolor="#5d5d5d"><font color="#ffffff"><b>사업장 정보</b></font></td>'+
									'</tr>'+
									'<tr>'+
									'<td align="left" width="30%">모국명</td>'+
									'<td align="left" id="TO_pOfficeName">'+ val.POFFICENAMESCODE +'</td>'+					
									'</tr>'+
									'<tr>'+
									'<td align="left" width="30%">사업장유형</td>'+
									'<td align="left" id="TO_workPlaceType">'+ officeName[i] +'</td>'+
									'</tr>'+
									'<tr>'+
									'<td align="left" width="30%">사업장명</td>'+
									'<td align="left" id="TO_workPlaceName">'+ val.WORKPLACENAME +'</td>'+
									'</tr>'+
									'<tr>'+
									'<td align="left" width="30%">사진정보</td>'+
									'<td align="left" id="TO_pic">&nbsp;&nbsp;사진보기&nbsp;<a href="#TO_img" data-rel="popup" data-position-to="window" data-transition="fade"><img class="popphoto" src="../img/pictures.png"></a></td>'+
//									'<td align="left" id="TO_pic"><a href="#TO_img" data-rel="popup" data-position-to="window" data-transition="fade">==사진보기==</a></td>'+
//									'<td align="left" id="TO_pic"><a href="#TO_img" data-rel="popup" data-position-to="window" data-transition="fade">&nbsp;&nbsp;사진보기&nbsp;</a><img class="popphoto" src="../img/pictures.png"></td>'+							
//									'<td align="left" id="TO_pic"><a href="#TO_img" data-rel="popup" data-role="button" data-position-to="window" data-inline="true" data-mini="true" data-transition="fade" data-theme="b">사진보기</a><a href="#TO_img" data-rel="popup" data-role="button" data-inline="true" data-mini="true" data-position-to="window" data-transition="fade" data-theme="b">사진찍기</a></td>'+
// 이걸써									'<td align="left" id="TO_pic">'+
//									'<div data-role="controlgroup" data-type="horizontal" id="officePhoto" data-inline="true" data-mini="true">'+
//									'<a href="#TO_img" data-rel="popup" data-position-to="window" data-transition="fade" data-role="button" data-theme="e">사진보기</a>'+
//									'<a href="transOffice_detail_capture.html" data-role="button" data-theme="e">사진찍기</a>'+
//									'</div>'+
// 여기까지									'</td>'+
									'</tr>'+
									
									//국사 사진 첨부(따로 첨부함. 화면이 깨지기 때문: 사진이미리떠버림. 클릭없이)
//									'<div data-role="popup" id="TO_img" data-overlay-theme="a" data-theme="d" data-corners="false">'+
//									'<a href="#" data-rel="back" data-role="button" data-theme="a" data-icon="delete" data-iconpos="notext" class="ui-btn-right">Close</a><img id="imgSrc" class="popphoto" src="../img/transOfficePhoto.png" style="max-height:512px;" alt="국사사진">'+
//									'</div>'+
									
									'<tr>'+
									'<td id="spaceTheme" colspan="2" bgcolor="#5d5d5d">'+
									'<p style="display:inline-block; float:left; vertical-align:middle;"><font color="#ffffff"><b>위치 정보</b></font></p>'+
									'<p style="display:inline-block; float:right">'+
									'<a href="transOffice_detail_map.html" data-role="button" id="officeMapButton" data-inline="true" data-mini="true" data-theme="b">지도보기</a>'+
									'</p>'+
									'</td>'+
//									'<td id="spaceTheme" colspan="2" bgcolor="#5d5d5d"><p style="display:inline-block; float:left; vertical-align:middle;"><font color="#ffffff"><b>위치 정보</b></font></p><p style="display:inline-block; float:right"><input type="button" value="지도보기" id="officeMapButton" data-inline="true" data-mini="true" data-theme="b" onClick=mapClick();></a></p></td>'+
//									'<td align="left" colspan="2" bgcolor="#5d5d5d"><font color="#ffffff"><b>위치 정보</b></font></td>'+
									'</tr>'+
									'<tr>'+
									'<td align="left" width="30%">주소</td>'+
									'<td align="left" id="TO_addr">'+ officeAddr + '</td>'+
									'</tr>'+ 
									'<tr>'+
									'<td align="left" width="30%">상세정보</td>'+
									'<td align="left" id="TO_addInfo">'+nullCheck(val.ADDINFO)+'</td>'+
									'</tr>'+
									'<tr>'+
									'<td align="left" width="30%">위도</td>'+
									'<td align="left" id="TO_lati">'+nullCheck(val.LATITUDE)+'</td>'+
									'</tr>'+
									'<tr>'+
									'<td align="left" width="30%">경도</td>'+
									'<td align="left" id="TO_longi">'+nullCheck(val.LONGITUDE)+'</td>'+
									'</tr>'+
									'<tr>'+
//									'<td align="left" colspan="2" bgcolor="#5d5d5d"><p style="display:inline-block; float:left; vertical-align:middle;"><font color="#ffffff"><b>출입 정보</b></font></p><p style="display:inline-block; float:right"><a href="#" data-role="button" id="officeModify" data-inline="true" data-mini="true" data-theme="b" onClick=officeModify();>수정</a></p></td>'+
									'<td align="left" colspan="2" bgcolor="#5d5d5d"><font color="#ffffff"><b>출입 정보</b></font></td>'+
									'</tr>'+
									'<tr>'+
									'<td align="left" width="30%">출입제한시간</td>'+
									'<td align="left" id="TO_timeLimit">' + nullCheck(val.ENTERLIMITEDTIME) +'</td>'+
//									'<td align="left" id="TO_timeLimit"><input type="text" id="anna" value="' + ifNull(val.ENTERLIMITEDTIME) +'" /></td>'+
									'</tr>'+
									'<tr>'+
									'<td align="left" width="30%">출입방법</td>'+
//									'<td align="left" id="TO_visitRule"><input type="text" id="anna" value="'+ ifNull(val.ENTERMETHOD) +'"></td>'+
									'<td align="left" id="TO_visitRule">'+ nullCheck(val.ENTERMETHOD) +'</td>'+
									'</tr>'+
									'<tr>'+
									'<td align="left" width="30%">건물관리자</td>'+
//									'<td align="left" id="TO_manager"><input type="text" id="anna" value="'+ ifNull(val.ENTERMANAGER) +'"></td>'+
									'<td align="left" id="TO_manager">'+ nullCheck(val.ENTERMANAGER) +'</td>'+
									'</tr>'+
									'<tr>'+
									'<td align="left" width="30%">건물전화</td>'+
//									'<td align="left" id="TO_tel"><input type="text" id="anna" value="'+ ifNull(val.ENTERTEL1) +'"></td>'+
									'<td align="left" id="TO_tel">'+ nullCheck(val.ENTERTEL1) +'</td>'+
									'</tr>'+
									'<tr>'+
									'<td align="left" width="30%">건물휴대폰</td>'+
//									'<td align="left" id="TO_manaPhone"><input type="text" id="anna" value="'+ ifNull(val.ENTERTEL2) +'"></td>'+
									'<td align="left" id="TO_manaPhone">'+ nullCheck(val.ENTERTEL2) +'</td>'+
									'</tr>'+
									'<tr>'+
//									'<td align="left" colspan="2" bgcolor="#5d5d5d"><p style="display:inline-block; float:left; vertical-align:middle;"><font color="#ffffff"><b>시설 정보</b></font></p><p style="display:inline-block; float:right"><a href="#" data-role="button" id="officeModify" data-inline="true" data-mini="true" data-theme="b" onClick=officeModify();>수정</a></p></td>'+
									'<td align="left" colspan="2" bgcolor="#5d5d5d"><font color="#ffffff"><b>시설 정보</b></font></td>'+
									'</tr>'+
									'<tr>'+
									'<td align="left" width="30%">장비내역1</td>'+
//									'<td align="left" id="TO_equiHistory1"><input type="text" id="anna" value="'+ ifNull(val.EQUIPMENTMEMO1) +'"></td>'+
									'<td align="left" id="TO_equiHistory1">'+ nullCheck(val.EQUIPMENTMEMO1) +'</td>'+
									'</tr>'+
									'<tr>'+
									'<td align="left" width="30%">장비내역2</td>'+
//									'<td align="left" id="TO_equiHistory2"><input type="text" id="anna" value="'+ ifNull(val.EQUIPMENTMEMO2) +'"></td>'+
									'<td align="left" id="TO_equiHistory2">'+ nullCheck(val.EQUIPMENTMEMO2) +'</td>'+
									'</tr>'+
									'<tr>'+
									'<td align="left" width="30%">장비내역3</td>'+
//									'<td align="left" id="TO_equiHistory3"><textarea id="addinfo" style="height:100px; overflow-x:hidden; overflow-y:auto;">'+ ifNull(val.ADDINFO) +'</textarea></td>'+
									'<td align="left" id="TO_equiHistory3">'+ nullCheck(val.EQUIPMENTMEMO3) +'</td>'+
									'</tr>'+
									'<tr>'+
									'<td align="left" colspan="2" bgcolor="#5d5d5d"><font color="#ffffff"><b>관리 정보</b></font></td>'+
									'</tr>'+
									'<tr>'+
									'<td align="left" width="30%">시설운용단</td>'+
									'<td align="left" id="TO_manageCenter">'+nullCheck(val.MANAGENSC)+'</td>'+
									'</tr>'+
									'<tr>'+
									'<td align="left" width="30%">시설운용팀</td>'+
									'<td align="left" id="TO_manageTeam">'+nullCheck(val.MANAGETEAM)+'</td>'+
									'</tr>'+
									'<td align="left" width="30%">유지보수사</td>'+
									'<td align="left" id="TO_manageCompany">'+nullCheck(val.MANAGENSC)+'</td>'+
									'</tr>'+
									'<tr>'+
									'<td align="left" width="30%">유지 보수<br>담당 (정)</td>'+
									'<td align="left" id="TO_managerName1">'+nullCheck(val.MANAGETEAM)+'</td>'+
									'</tr>'+
									'<td align="left" width="30%">담당연락처</td>'+
									'<td align="left" id="TO_managerTel1">'+nullCheck(val.MANAGENSC)+'</td>'+
									'</tr>'+
									'<tr>'+
									'<td align="left" width="30%">유지 보수<br>담당 (부)</td>'+
									'<td align="left" id="TO_managerName2">'+nullCheck(val.MANAGETEAM)+'</td>'+
									'</tr>'+
									'<td align="left" width="30%">담당연락처</td>'+
									'<td align="left" id="TO_managerTel2">'+nullCheck(val.MANAGENSC)+'</td>'+
									'</tr>'+
									'</table>';

					//테이블 삽입								
//					$("#table_transOfficeDetail").append(transOfficeTB);
										
					//데이터 세팅
					var i=val.WORKPLACETYPE;
					$('#TO_workPlaceType').text(val.POFFICENAMESCODE);
					$('#TO_pOfficeName').text(val.WORKPLACETYPE_NM);
					$('#TO_workPlaceName').text(val.WORKPLACENAME);

	
					$('#TO_addr').text(val.ADDR);
					$('#TO_addInfo').text(nullCheck(val.ADDINFO));
					$('#TO_lati').text(nullCheck(val.LATITUDE));
					$('#TO_longi').text(nullCheck(val.LONGITUDE));				
					$('#TO_timeLimit').text(nullCheck(val.ENTERLIMITEDTIME));
					$('#TO_visitRule').text(nullCheck(val.ENTERMETHOD));
					$('#TO_manager').text(nullCheck(val.ENTERMANAGER));
					$('#TO_tel').text(nullCheck(val.ENTERTEL1));
					$('#TO_manaPhone').text(nullCheck(val.ENTERTEL2));
					$('#TO_equiHistory1').text(nullCheck(val.EQUIPMENTMEMO1));
					$('#TO_equiHistory2').text(nullCheck(val.EQUIPMENTMEMO2));
					$('#TO_equiHistory3').text(nullCheck(val.EQUIPMENTMEMO3)); 
					$('#TO_manageCenter').text(nullCheck(val.MANAGECENTER));	
					$('#TO_manageTeam').text(nullCheck(val.MANAGETEAM));	
					$('#TO_manageCompany').text(nullCheck(val.MANAGECOMPANY));	
					$('#TO_managerName1').text(nullCheck(val.MANAGERNAME1));	
					$('#TO_managerTel1').text(nullCheck(val.MANAGERTEL1));	
					$('#TO_managerName2').text(nullCheck(val.MANAGERNAME2));	
					$('#TO_managerTel2').text(nullCheck(val.MANAGERTEL2));	
				
					
					officeAddr = val.ADDR;					
//					officeAddr = val.ADDR + " " + val.ADDRDTL;
					mapOfficeName = val.WORKPLACENAME;
					
//					$.mobile.hidePageLoadingMsg();
				});
			}	
		},
		error: function(jqXHR, textStatus, errorThrown) {
			console.log(transOfficeDetail_debugPrefix + "국사상세정보 출력 에러 : " + jqXHR.status);
	        console.log(transOfficeDetail_debugPrefix + "국사상세정보 출력 에러 : " + jqXHR.responseText);
			console.log(transOfficeDetail_debugPrefix + "국사상세정보 출력 에러 : " + errorThrown);
	    }
//	}).done(function(){
//		showTransCnt++;
//		alert("showTransOffice_detail" + showTransCnt);
	});
}


//국사 사진보기
function showTransOfficeImg(){
	$.ajax({
		url: url + "MossWorkplaceDetail",
		type: "post",
		timeout: 10*1000,
		dataType: "json",
		data: {workplaceSeqNum:workplaceSN},
		
		success: function(result){
			var bodyData = result.body;
			var headerData = result.header;
			var imgPop="";
			
			if(headerData.result != 0){
				console.log(transOfficeDetail_debugPrefix + "사진 데이터 없음");
			}
			
			$.each(bodyData, function(key, val){								 
				imgPop = '<div data-role="popup" id="TO_img" data-overlay-theme="a" data-theme="d" data-corners="false">'+
					     '<a href="#" data-rel="back" data-role="button" data-theme="a" data-icon="delete" data-iconpos="notext" class="ui-btn-right">Close</a><img id="imgSrc" class="popphoto" src="../img/transOfficePhoto.png" style="max-height:512px;" alt="국사사진">'+		
					     '</div>';
				
						//$("#imgSrc").attr('src', 'srcImage.jpg');
				
				console.log("사진파일 :::::: " +val.FILEBINARY);
							
//				if(val.FILEBINARY == null){
//					$("#TO_pic").text("  사진없음 ");
//				}else{
//					$("#table_transOfficeDetail").append(imgPop).trigger("create");	
//				}									
			});
		},
		error: function(jqXHR, textStatus, errorThrown) {
			console.log(transOfficeDetail_debugPrefix + "국사사진 출력 에러 : " + jqXHR.status);
	        console.log(transOfficeDetail_debugPrefix + "국사사진 출력 에러 : " + jqXHR.responseText);
			console.log(transOfficeDetail_debugPrefix + "국사사진 출력 에러 : " + errorThrown);
	    }
	});
}

function showOfficeMap() {
	var position = new daum.maps.LatLng(geocodeLat, geocodeLng);
		daum_map = new daum.maps.Map(document.getElementById('map_canvas'), {
		center : position,
		level : 4,
		mapTypeId : daum.maps.MapTypeId.ROADMAP
	});

	//원 그리기
	var circle = new daum.maps.Circle({
//		center : new daum.maps.LatLng(geocodeLat, geocodeLng),
//		radius : 500,
		strokeWeight : 4,
		strokeColor : "#F10000",
		strokeOpacity : 0.3,
		fillOpacity : 0.1
	});
	circle.setMap(daum_map);
	
	var icon = new daum.maps.MarkerImage('../img/map_location.png', new daum.maps.Size(50, 50));
	
	var marker = new daum.maps.Marker({ position : position, image : icon });
		marker.setMap(daum_map);

	var infowindow = new daum.maps.InfoWindow({
		content: '<p style="margin:7px 22px 7px 12px;font:12px/1.5 sans-serif">'+ mapOfficeName +'</p>',
		removable : true
	});
	
	daum.maps.event.addListener(marker, "click", function() {
		infowindow.open(daum_map, marker);
	});
	
	//	맵 컨트롤러
	var zoomControl = new daum.maps.ZoomControl();
	daum_map.addControl(zoomControl, daum.maps.ControlPosition.RIGHT);
	var mapTypeControl = new daum.maps.MapTypeControl();
	daum_map.addControl(mapTypeControl, daum.maps.ControlPosition.TOPRIGHT);
}

function getOfficeGeocode(officeAddr) {
	console.log(transOfficeDetail_debugPrefix + "============ Geocoding start : " + officeAddr + " ============");
	$.ajax({
		url: "http://maps.googleapis.com/maps/api/geocode/json",
	    type: 'get',
	    dataType: "json",
		timeout: 10 * 1000,
		data: {address:officeAddr, sensor:false},
		success: function (result) {
			console.log(transOfficeDetail_debugPrefix + "============ Geocoding success============");
			
			var results = result.results;

			$.each(results, function(key, val) {
				geocodeLat = val.geometry.location.lat;
				geocodeLng = val.geometry.location.lng;
		    });
		},
		error: function(jqXHR, textStatus, errorThrown) {
	        console.log(transOfficeDetail_debugPrefix + "============ Geocoding error ============ : " + jqXHR.status);
	        console.log(transOfficeDetail_debugPrefix + "============ Geocoding error ============ : " + jqXHR.responseText);
			console.log(transOfficeDetail_debugPrefix + "============ Geocoding error ============ : " + errorThrown);
	    }
	}).done(function() {
		console.log(transOfficeDetail_debugPrefix + "============ Geocoding Lat : "+ geocodeLat +"============");
		console.log(transOfficeDetail_debugPrefix + "============ Geocoding Lng : "+ geocodeLng +"============");
		
		showOfficeMap();
	});
}

//사업장 상세 사진 입력
//$(document).on("pagebeforeshow","#page_transOffice_detail_capture",function(event) {
//	//	Navbar의 클릭 이벤트 시 버튼 토글 상태를 해제
//	$("div:jqmData(role='navbar')").click(function () {
//		$("a").removeClass("ui-btn-active");
//	});
//	// header의 back 버튼 클릭 시 이동할 상세 페이지 셋팅
//	$("#btn_back").attr("href", $("#btn_back").attr("href") + "?workplaceSeqNum=" + workplaceSN);
//	
//	$('#btn_captureImg').click(function() {
//		take_pic();
//	});
//	$('#btn_loadImg').click(function() {
//		album_pic();
//	});
//	$('#btn_setComment_capture').click(function() {
//		fileUpload();
//	});
//});

//$(document).on("pagecreate","#page_transOffice_detail",function(event){
//	showTransOffice_detail();
//});

$(document).on("pagebeforeshow","#page_transOffice_detail",function(event){
	showTransOffice_detail();
//	$('#page_transOffice_detail').trigger('pagecreate');	
	showTransOfficeImg();
});

$(document).on("pageshow","#page_transOffice_detail",function(event){
//	alert("pageshow");
//	setTimeout(function() {
//		$('#page_transOffice_detail').trigger('pagecreate');	
//		alert("pageshow");
//	},5 * 1000);
//	showTransOffice_detail();
//	showTransOfficeImg();
});

$(document).on("pageshow","#page_map_transOffice_detail",function(event){	
	showTransOffice_detail();
	showTransOfficeImg();
});

//고장 상황(진행) 상세 지도 보기
$(document).on("pageshow","#page_transOffice_detail_map",function(event) {
	//	Navbar의 클릭 이벤트 시 버튼 토글 상태를 해제
	$("div:jqmData(role='navbar')").click(function () {
		$("a").removeClass("ui-btn-active");
	});
	// header의 back 버튼 클릭 시 이동할 상세 페이지 셋팅
	$("#btn_back").attr("href", $("#btn_back").attr("href") + "?workplaceSeqNum=" + workplaceSN);
	
	var header = $("div[data-role='header']:visible");
	var footer = $("div[data-role='footer']:visible");
	var content = $("div[data-role='content']:visible");
	var viewport_height = $(window).height();

	var content_height = viewport_height - header.outerHeight() - footer.outerHeight();
	/* Trim margin/border/padding height */
	content_height -= (content.outerHeight() - content.height());
	// 디바이스에 사이즈에 동적으로 map height를 설정
	$("#map_canvas").css('min-height', content_height);
	// 다음맵 호출 
	$("#btn_callNavi").click(function() {
		
		$.mobile.loading( "show", {
			  text: "올레네비를 실행합니다.",
			  textVisible: true,
			  theme: "a",
			  html: ""
		});
		// 현재 위치 정보를 수집 한 뒤 목적지까지 길찾기 시작
		navigator.geolocation.getCurrentPosition(onCurrentPosSuccess, onCurrentPosError);
	});
	// 맵을 그린다.
	getOfficeGeocode(officeAddr);
});
