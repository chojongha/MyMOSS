var manualList_debugPrefix = "[board_manual.js] : ";
var alarmNoti_serCode=new Array();
var alarmNoti_serName=new Array();
var alarmNotice_serCode=new Array();
var manualSel="";
var serCode=new Array();
var serName=new Array();
var maChecked="";

//서비스분야배열생성
function serviceCode_CodeName(){
		
	$.ajax({
		url: url+"ServiceList",
		type: "post",
		timeout: 10*1000,
		dataType: "json",
		success:function(result){
			var bodyData=result.body;
			var headerData=result.header;
			
			if(headerData.result != 0){
				console.log(commonDebugPrefix + "분야데이터없음");
			}else{
				$.each(bodyData, function(key,val){						
					serCode[key]=val.CD;
					serName[key]=val.CD_NM;									
				});	
				for(var i=0; i<serCode.length; i++){
					console.log(manualList_debugPrefix + "서비스분야코드 : " + serCode[i]);
					console.log(manualList_debugPrefix + "서비스분야이름 : " + serName[i]);
				}
			}
		},
		error : function(){
			console.log(commonDebugPrefix + "서비스코드배열 생성 에러");
		}
	});
}

//function manualCSS(){
//	//디바이스에 따라 화면 높이 맞추기
//	var header = $("div[data-role='header']:visible");
//	var footer = $("div[data-role='footer']:visible");
//	var content = $("div[data-role='content']:visible"); 
//	var viewport_height = $(window).height();
//			
//	var content_height = viewport_height - header.outerHeight() - footer.outerHeight();	
//	
//	content_height -= (content.outerHeight() - content.height());
//	
//	$("#manual_content").css('height', content_height);
//	
//	var manualConH = $("#manual_content").height();
//	var manualSearH = $("#selectNsearch").height() + 13;	//13은 magine 준 부분
//		
//	var manualLiH = manualConH - manualSearH;
//											
//	$("#listManual").css('height', manualLiH);
//} 

//셀렉트박스 생성
function makeSel(){
	
	var manualSel="";
	
	if(serCode.length > 0){
		
		//페이지에 따라 달리 생성
		if($.mobile.activePage.attr('id') == 'page_manualList'){
			console.log(manualList_debugPrefix + "=======전체분야 셀렉트박스=======");
					
			//생성
			for(var i=0; i<serCode.length; i++){																			
				manualSel += "<option value='" + serCode[i] + "'>" + serName[i] + "</option>";			
			}
			//삽입
			$('#manualField').append(manualSel).trigger("create").selectmenu( "refresh" );
			
		}else if($.mobile.activePage.attr('id') == 'page_alarmManualList'){
			
			console.log(manualList_debugPrefix + "======고장관련분야 셀렉트박스======= ::: " + detail_services);
			
			//고장진행에서 넘어온 분야가 없을경우 모든 분야를 보여줌
			if(detail_services == null){
				//생성
				for(var i=0; i<serCode.length; i++){																			
					manualSel += "<option value='" + serCode[i] + "'>" + serName[i] + "</option>";			
				}
				//삽입
				$('#manualField').append(manualSel).trigger("create").selectmenu( "refresh" );
			}else{
				//고장관련 서비스코드 배열생성(문자열로 넘어온것 ","로 끊어서 배열에 저장)
				alarmNoti_serCode = detail_services.split(",");
			}
			
			//배열 중복 제거
			var unique_serCode=new Array;				
			$.each(alarmNoti_serCode, function(i, el){
				if($.inArray(el, unique_serCode) === -1) unique_serCode.push(el);
			});
			
			//고장관련 서비스이름 배열생성 (서비스코드와 같은 서비스이름 인덱스 번호의 값을 가져옴)
			var index = 0;					
			for(var i=0; i<unique_serCode.length; i++){	
				var aaa = unique_serCode[i];   	// '01', '02', '03', '04' ...
				var bbb = eval(aaa)-1;				// 1, 2, 3, 4  //eval 함수는 문자열을 숫자로 변환시켜줌 01->1  //-1한 이유는 밸류와 index번호를 맞춰주기 위함. bbb의 값이 내가 꺼내올 배열의 인덱스 번호가 되어야 한다. 
				var ccc = serName[bbb];				// "a", "b", "c", ....
				alarmNoti_serName[index] = ccc;
				index++;
				//alarmNoti_serName[index++] = serName[eval(alarmNoti_serCode[i])-1];  	//이것은 위에 5줄을 한줄로 표현한것.
			}
			
			for(var i=0; i<unique_serCode.length; i++){
				console.log(manualList_debugPrefix + "고장관련 서비스이름 배열생성 ::: " + alarmNoti_serName[i]);
			}
			
			//고장상황에 맞춘 셀렉트 박스 생성
			for(var i=0; i<unique_serCode.length; i++){
				manualSel += "<option value='" + unique_serCode[i] + "'>" + alarmNoti_serName[i] + "</option>";
			}
			//셀렉트박스 삽입
			$('#manualField').html(manualSel).trigger("create").selectmenu( "refresh" );
		}else{
			//not (아무런 console도 안뜨게 주어진것.)
		}	
	}else{
		//생성
		manualSel = '<option value="no">분야없음</option>';
		//삽입
		$('#manualField').html(manualSel).trigger("create").selectmenu( "refresh" );
	}
	//매뉴얼 선택
	$("#manualField").val(maChecked).selectmenu( "refresh" );
}	
	
function storeMa(){
	
	maChecked = $("#manualField > option:selected").val();
	
	console.log(manualList_debugPrefix + "선택된 분야 ==== " + maChecked );
}

//검색기능
function filter(){
	var value = $('#word').val();	
	var valueUp = $('#word').val().toUpperCase(); //toUpperCase : 검색어를 대문자로 전환
	$('#listview > li').hide();
	$("#listview > li:contains('"+value+"')").show();
	$("#listview > li:contains('"+valueUp+"')").show();
}

//셀렉트박스 선택을 통해 업무매뉴얼 리스트불러오기
function showManualList(){
	// 페이지가 보여지면서 로더를 보여준다.
	$.mobile.loading( "show", {
		  text: "리스트를 읽어오는 중 입니다.",
		  textVisible: true,
		  theme: "a",
		  html: ""
	});

	//선택된 분야 읽어오기
	var serviceId=$("#manualField > option:selected").val();
	
	console.log(manualList_debugPrefix + "리스트에서 읽어온 분야 ::: " + serviceId);
	
	//매뉴얼리스트생성
	$.ajax({
		url: url + "ManualList",
		type: "post",
		timeout: 10*1000,
		dataType: "json",
		data:{serviceid:serviceId},
		success: function(result){ 
			var bodyData = result.body;
			var headerData = result.header;
			var manualLi = "";
		
		if(headerData.result != 0){
			manualLi = "<li data-icon='false'> "+
					   "<a href='#'>" +
					   "<center><h2>정보가 없습니다. 분야를 선택하세요.</h2></center>" +     
					   "</a>" +
					   "</li>";
		}
		else{
			$.each(bodyData, function(key, val){	
				
				if($.mobile.activePage.attr('id') != 'page_manualList'){
					manualLi += "<li data-icon='false'>" +
								"<a href='alarmList_noti_detail_manual_detail.html?manualSeqNum="+val.MANUALSEQNUM+"'>" +	
								"<div class='listContent'>" +
								"<h2>"+ val.SUBJECT +"</h2>" +
								"<p style='display:inline-block; float:left'>"+ val.WRITEDATE +"</p>" +
                                "<p style='display:inline-block; float:right'>"+  val.WRITERNAME + "</p>" +
                                "</div>" +
                                "</a>" +
                                "</li>";										
				}else{
					manualLi += "<li data-icon='false'>" +
								"<a href='board_manual_detail.html?manualSeqNum="+val.MANUALSEQNUM+"'>" +	
								"<div class='listContent'>" +
								"<h2>"+ val.SUBJECT +"</h2>" +
								"<p style='display:inline-block; float:left'>"+ val.WRITEDATE +"</p>" +
			                    "<p style='display:inline-block; float:right'>"+  val.WRITERNAME + "</p>" +
			                    "</div>" +
			                    "</a>" +
			                    "</li>";													
				}					
			});
		}
		//매뉴얼 리스트 삽입
		$('#listview').html(manualLi).listview("refresh");
		$.mobile.hidePageLoadingMsg();		
		},
		error: function(jqXHR, textStatus, errorThrown){
			console.log(manualList_debugPrefix + "매뉴얼리스트 출력 에러 : " + jqXHR.status);
			console.log(manualList_debugPrefix + "매뉴얼리스트 출력 에러 : " + jqXHR.responseText);
			console.log(manualList_debugPrefix + "매뉴얼리스트 출력 에러 : " + errorThrown);		
		} 
	});
}

$(document).on("pageshow","#page_login", function(event){  
	serviceCode_CodeName();
});


$(document).on("pagebeforeshow","#page_manualList", function(event){
	makeSel();
});

$(document).on("pageshow","#page_manualList", function(event){
	//화면고정
//	manualCSS();
	showManualList();
	
	$("#btn_refresh").click(function () {
		$("#listview").empty();

		showManualList();
	});
});

$(document).on("pagebeforeshow","#page_alarmManualList", function(event){
	makeSel();
});

$(document).on("pageshow","#page_alarmManualList", function(event){
//	manualCSS();
	//화면상 백버튼 링크걸어주기
	$('#before_alarmDetail').attr('href','alarmList_noti_detail.html?notiseqnum=' + notiseqnum);
	
	showManualList();
	
	$("#btn_refresh").click(function () {
		$("#listview").empty();
		
		showManualList(); 
	});
});

$(document).on("pagehide","#page_manualList", function(event){
	if($.mobile.activePage.is('#page_manual_detail')){
		
	}else{
		maChecked="";
	}
});