var transOffice_debugPrefix = "[transOffice.js] : ";
var FirstCode="";
var SecondCode="";
var ThirdCode="";
var danChecked="";
var moChecked="";
var officeChecked="";
var officeCode = new Array();
var officeName = new Array();
var danCo = new Array();
var danNa = new Array();

//단 배열 생성
function danArray(){

	$.ajax({
		url: url+"WorkPlaceCodeInfoByUserId",
		type: "post",
		timeout: 10*1000,
		dataType: "json",
		data: {userid : loginId},
		success:function(result){
			var danorgcodeData=result.danorgcode;
			var headerData=result.header;
			
			if(headerData.result != 0){
				console.log(transOffice_debugPrefix + "운용단 데이터 없음");
			}else{
				$.each(danorgcodeData, function(key,val){	 
					danCo[key]=val.ORG_ID;
					danNa[key]=val.ORG_NM;
										
//					console.log(transOffice_debugPrefix + "운용단코드 : " + val.ORG_ID);
//					console.log(transOffice_debugPrefix + "운용단이름 : " + val.ORG_NM);
				});	
				
				console.log(transOffice_debugPrefix + "운용단 개수 : " + danCo.length);
				
				if(danCo.length == 1){
					console.log(transOffice_debugPrefix + "자신운용단만 볼수 있는 유저");
				}else{
					console.log(transOffice_debugPrefix + "전국운용단 볼수 있는 유저");
				}
			}
		},
		error : function(){
			console.log(transOffice_debugPrefix + "운용단 배열 생성 에러");
		}
	});	
}

//작업장 유형 배열 생성
function OfficeArray(){
	
	$.ajax({
		url: url+"MossCode",
		type: "post",
		timeout: 10*1000,
		dataType: "json",
		data: {category : 'WORKPLACETYPE'},
		success:function(result){
			var bodyData=result.body;
			var headerData=result.header;
			
			if(headerData.result != 0){
				console.log(commonDebugPrefix + "작업장 유형 데이터 없음");
			}else{
				$.each(bodyData, function(key,val){						
					officeCode[key]=val.CODE;
					officeName[key]=val.CODEVALUE;									
				});	
				for(var i=0; i<officeCode.length; i++){
					console.log(transOffice_debugPrefix + "작업장코드 : " + officeCode[i]);
					console.log(transOffice_debugPrefix + "작업장이름 : " + officeName[i]);
				}
			}
		},
		error : function(){
			console.log(transOffice_debugPrefix + "작업장 유형 배열 생성 에러");
		}
	});
}

function OfficeCSS(){
	//디바이스에 따라 화면 높이 맞추기
	var header = $("div[data-role='header']:visible");
	var footer = $("div[data-role='footer']:visible");
	var content = $("div[data-role='content']:visible"); 
	var viewport_height = $(window).height();
			
	var content_height = viewport_height - header.outerHeight() - footer.outerHeight();	
	
	content_height -= (content.outerHeight() - content.height());
	
	$("#transOffice_content").css('height', content_height);
	
	var officeConH = $("#transOffice_content").height();
	var officeSearH = $("#selectNsearch").height() + 13;	//13은 magine 준 부분
		
	var officeLiH = officeConH - officeSearH;
											
	$("#officeList").css('height', officeLiH);
}

//운용단 셀렉트박스 생성
function makeFirstSel(){
	
	var FirstSel="";
	
	//생성
	for(var i=0; i<danCo.length; i++){
		FirstSel += "<option value='" + danCo[i] + "'>" + danNa[i] + "</option>";
	}
	
	//삽입
	if(danCo.length == 1){
		$('#FirstField').html(FirstSel).trigger("create").selectmenu( "refresh" );
	}else{
		$('#FirstField').append(FirstSel).trigger("create").selectmenu( "refresh" );
	}
	

	//작업장 선택
	$("#FirstField").val(danChecked).selectmenu( "refresh" );
	
	console.log(transOffice_debugPrefix + "=============운용단 셀렉트박스생성=============");
}

function storeDan(){
	danChecked = $("#FirstField > option:selected").val();
	
	console.log(transOffice_debugPrefix + "선택된 운용단 ==== " + danChecked);
}

//모국 셀렉트박스 생성
function makeSecondSel(){

	$.ajax({
		url: url+"WorkPlaceCodeInfoByUserId",
		type: "post",
		timeout: 10*1000,
		dataType: "json",
		data: {userid:userID},
		success:function(result){
			var pofficeData=result.poffice;
			var headerData=result.header;
			var SecondSel="";

			if(headerData.result != 0){
				console.log(transOffice_debugPrefix + "모국 데이터 없음");
			}else{
				$.each(pofficeData, function(key,val){
					//모국 생성
					SecondSel += "<option value='" + val.POFFICESCODE + "'>" + val.POFFICENAMESCODE + "</option>";

					console.log(transOffice_debugPrefix + "모국코드 : " + val.POFFICESCODE); 
					console.log(transOffice_debugPrefix + "모국이름 : " + val.POFFICENAMESCODE);
				});
				//모국 삽입
				$('#SecondField').append(SecondSel).trigger("create").selectmenu( "refresh" );
			}
			//모국 선택
			$("#SecondField").val(moChecked).selectmenu( "refresh" );
			
			console.log(transOffice_debugPrefix + "=============모국 셀렉트박스생성 완료=============");
		},
		error : function(){
			console.log(transOffice_debugPrefix + "모국 셀렉트박스 생성 에러");
		}
	});
}

//전국 모국 셀렉트박스 생성
function makeAllSecondSel(){

	$("select[name='select-choice-second'] option").not("[value='not2']").remove();
	
	$.ajax({
		url: url+"WorkPlaceCodeInfoByDanOrgCode",
		type: "post",
		timeout: 10*1000,
		dataType: "json",
		data: {danorgcode:danChecked},
		success:function(result){
			var pofficeData=result.poffice;
			var headerData=result.header; 
			var SecondSel="";

			if(headerData.result != 0){
				console.log(transOffice_debugPrefix + "전국 모국 데이터 없음");
			}else{
				$.each(pofficeData, function(key,val){
					//전국 모국 생성
					SecondSel += "<option value='" + val.POFFICESCODE + "'>" + val.POFFICENAMESCODE + "</option>";

					console.log(transOffice_debugPrefix + "전국 중 선택 모국코드 : " + val.POFFICESCODE); 
					console.log(transOffice_debugPrefix + "전국 중 선택 모국이름 : " + val.POFFICENAMESCODE);
				});
				//전국 모국 삽입				
				$('#SecondField').append(SecondSel).trigger("create").selectmenu( "refresh" );
			}
			//전국 모국 선택
			$("#SecondField").val(moChecked).selectmenu( "refresh" );
			
			console.log(transOffice_debugPrefix + "=============전국 모국 셀렉트박스생성 완료=============");
		},
		error : function(){
			console.log(transOffice_debugPrefix + "전국모국 셀렉트박스 생성 에러");
		}
	});
}

function storeMo(){
	
	moChecked = $("#SecondField > option:selected").val();
	
	console.log(transOffice_debugPrefix + "선택된 모국 ==== " + moChecked );
}

//작업장 유형 셀렉트박스 생성
function makeThirdSel(){
	
	var ThirdSel="";
	
	//생성
	for(var i=0; i<officeCode.length; i++){
		ThirdSel += "<option value='" + officeCode[i] + "'>" + officeName[i] + "</option>";
	}
	//삽입
	$('#ThirdField').append(ThirdSel).trigger("create").selectmenu( "refresh" );

	//작업장 선택
	$("#ThirdField").val(officeChecked).selectmenu( "refresh" );
	
	console.log(transOffice_debugPrefix + "=============작업장유형 셀렉트박스생성=============");
}

function storeOffice(){
	officeChecked = $("#ThirdField > option:selected").val();
	
	console.log(transOffice_debugPrefix + "선택된 작업장 ==== " + officeChecked );
}

//검색기능
function filter(){
	var value = $('#word').val();	
	var valueUp = $('#word').val().toUpperCase(); //toUpperCase : 검색어를 대문자로 전환
	$('#listview > li').hide();
	$("#listview > li:contains('"+value+"')").show();
	$("#listview > li:contains('"+valueUp+"')").show();
}

//셀렉트박스 선택을 통해 국사 리스트불러오기
function showWorkplaceList(){
	
	// 페이지가 보여지면서 로더를 보여준다.
	$.mobile.loading( "show", {
		  text: "리스트를 읽어오는 중 입니다.",
		  textVisible: true,
		  theme: "a",
		  html: ""
	});

	//선택된 값 얻어오기
	FirstCode=$("#FirstField > option:selected").val();
	SecondCode=$("#SecondField > option:selected").val();
	ThirdCode=$("#ThirdField > option:selected").val();
	
	console.log(transOffice_debugPrefix + "선택된 운용단 ::: " + FirstCode);
	console.log(transOffice_debugPrefix + "선택된 모국 ::: " + SecondCode);
	console.log(transOffice_debugPrefix + "선택된 작업장 ::: " + ThirdCode);
	
	//국사 리스트생성
	$.ajax({
		url: url + "MossWorkplaceList",
		type: "post",
		timeout: 10*1000,
		dataType: "json",
		data:{danorgcode:FirstCode, pofficescode:SecondCode, workplacetype:ThirdCode},
		success: function(result){ 
			var bodyData = result.body;
			var headerData = result.header;
			var workplaceLi="";
					
		if(headerData.result != 0){
				if(FirstCode == 'not1'){
					workplaceLi = "<li data-icon='false'>" +
							   	  "<a href='#'>" +
							      "<center><h2>운용단을 선택하세요.</h2></center>" +     
							   	  "</a>" +
							      "</li>";
				}else if(SecondCode == 'not2'){
					workplaceLi = "<li data-icon='false'>" +
							   	  "<a href='#'>" +
							      "<center><h2>모국을 선택하세요.</h2></center>" +     
							   	  "</a>" +
							      "</li>";
				}else if(ThirdCode == 'not3'){
					workplaceLi = "<li data-icon='false'>" +
							   	  "<a href='#'>" +
							      "<center><h2>작업장을 선택하세요.</h2></center>" +     
							   	  "</a>" +
							      "</li>";
				}else{
					workplaceLi = "<li data-icon='false'> "+
							   	  "<a href='#'>" +
							      "<center><h2>정보가 없습니다.</h2></center>" +     
							   	  "</a>" +
							      "</li>";
				}			
		}
		else{
			$.each(bodyData, function(key, val){	
				workplaceLi += "<li data-icon='false'>" +
							   "<a href='transOffice_detail.html?workplaceSeqNum="+val.WORKPLACESEQNUM+"'>" +	
							   "<div class='listContent'>" +
							   "<h2>"+ val.WORKPLACENAME +"</h2>" +
							   "<p style='display:inline-block; float:right'>"+ val.ADDR + "</p>" +
							   "</div>" +
							   "</a>" +
							   "</li>";										
			});
		}
		//국사 리스트 삽입
		$('#listview').html(workplaceLi).listview("refresh");
		$.mobile.hidePageLoadingMsg();	
		},
		error: function(jqXHR, textStatus, errorThrown){
			console.log(transOffice_debugPrefix + "국사리스트 출력 에러 : " + jqXHR.status);
			console.log(transOffice_debugPrefix + "국사리스트 출력 에러 : " + jqXHR.responseText);
			console.log(transOffice_debugPrefix + "국사리스트 출력 에러 : " + errorThrown);		
		} 
	});
}

$(document).on("pageshow","#page_login", function(event){  
	OfficeArray();
});

$(document).on("pageshow","#page_index", function(event){  
	danArray();
});

$(document).on("pagebeforeshow","#page_transOffice", function(event){	
	if(danCo.length == 1){
		makeFirstSel();
		makeSecondSel();
		makeThirdSel();
	}else{
		makeFirstSel();
		makeAllSecondSel();
		makeThirdSel();
	}
});

$(document).on("pageshow","#page_transOffice", function(event){
	OfficeCSS();
	showWorkplaceList();

	$("#btn_refresh").click(function() {
		$("#listview").empty();
		
		showWorkplaceList();
	});
});

$(document).on("pagehide","#page_transOffice", function(event){
	if($.mobile.activePage.is('#page_transOffice_detail')){
		
	}else{
		danChecked="";
		moChecked="";
		officeChecked="";
	}
});
