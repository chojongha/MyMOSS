var manualDetail_debugPrefix = "[board_manual_detail.js] : ";
var manualSeqNum="";
var beforeChecked="";

//상세 페이지 출력
function showManualDetail(){

	$.mobile.loading( "show", {
		  text: "로딩중...",
		  textVisible: true,
		  theme: "a",
		  html: ""
	}); 
	
	//매뉴얼 시퀀스넘버 받기
	manualSN=Request("manualSeqNum");
	
	console.log(manualDetail_debugPrefix + "넘어온 시퀀스넘버 = " + manualSN);
	
	$.ajax({
		url: url+"ManualDetail",		
		type: "post",
		timeout : 10 * 1000,
		dataType : "json",
		data: {manualSeqNum:manualSN}, //인풋(접속)		
		success: function (result) {
			var bodyData = result.body; //아웃풋 정보 가져오기
			var headerData = result.header;
			
			if(headerData.result != 0){
				$.mobile.hidePageLoadingMsg();
				showCommonAlert("에러", headerData.errMsg);
			}else{
				$.each(bodyData, function(key, val){ //아웃풋 뿌리기
					
					var manualDetailTB = "<table class='basic' id='table_detail'>"+
										 "<tr>"+ 
										 "<th>제 목</th>"+
										 "<td colspan='3' id='manual_title'></td>"+
										 "</tr>"+
										 "<tr>"+
										 "<th>작성일시</th>"+
										 "<td colspan='3' id='manual_writeDate'></td>"+
										 "</tr>"+							
										 "<tr>"+
										 "<th>분 야</th>"+
										 "<td colspan='3' id='manual_services'></td>"+
										 "</tr>"+
										 "<tr>"+
										 "<th width='20%'>작 성 자</th>"+
										 "<td width='30%' id='manual_writer'></td>"+
										 "<th width='20%'>조 회 수</th>"+
										 "<td width='30%' id='manual_viewCount'></td>"+
										 "</tr>"+	
										 "<tr>"+
										 "<td colspan='4' id='manual_content' width='100%' height='320' valign='top'></td>"+  //컨텐츠부분 크기고정
										 "</tr>"+
										 "<tr>"+
										 "<th width='20%'>첨부파일</th>"+
										 "<td colspan='3' id='manual_file'>"+	
										 "</tr>"+
										 "</table>"; 				
					
					var manualCon = "<div id='contents' style='overflow-y:auto; width:100%; height:100%; padding:4px'><div>"; //화면범위 넘어가면 스크롤 생성				
					
					console.log(manualDetail_debugPrefix + "첨부파일 일련번호 : " + val.ATTACHSEQNUM);
					
					function attachFile(){
						window.open(+ url + "filedownload?attachSeqNum="+ val.ATTACHSEQNUM, '_blank', 'EnableViewPortScale=yes');
					}
					
					//본문 테이블 넣기													 			 				
					$('#manual_table').html(manualDetailTB);				
					$('#manual_content').html(manualCon);
					//본문 데이터 세팅				
					$('#manual_title').text(val.SUBJECT);
					$('#manual_writeDate').text(val.WRITEDATE);
					$('#manual_services').text(val.SERVICEIDNAME+" > "+val.SERVICESUBIDNAME);
					$('#manual_writer').text(val.WRITERNAME);
					$('#manual_viewCount').text(val.READCNT);
					$('#contents').append(val.CONTENT + "<a href='transOffice_detail.html'>눌러봐</a>");
					
					if(val.FILENAME==null){
						$('#manual_file').text("없음");
					}else{ 
						if(val.FILENAME.length > 20){		//첨부파일명이 너무 길경우 문자열자름.
							if(device.platform == "Android"){
								$('#manual_file').append(val.FILENAME.substr(0,20)+ "..." + "<a href='" + url + "filedownload?attachSeqNum="+ val.ATTACHSEQNUM +"' id='manual_file'><img class='fileDown' src='../img/download.png' style='width:1.5em; height:1.5em;'></a>");								
							}else{
								$('#manual_file').append(val.FILENAME.substr(0,20)+ "..." + "<a href='" + url + "filedownload?attachSeqNum="+ val.ATTACHSEQNUM +", '_blank', 'EnableViewPortScale=yes' id='manual_file'><img class='fileDown' src='../img/download.png' style='width:1.5em; height:1.5em;'></a>");
//								attachFile();
							}						
						}else{
							if(device.platform == "Android"){
								$('#manual_file').append(val.FILENAME + "<a href='" + url + "filedownload?attachSeqNum="+ val.ATTACHSEQNUM +"' id='manual_file'><img class='fileDown' src='../img/download.png' style='width:1.5em; height:1.5em;'></a>");
								
							}else{
								$('#manual_file').append(val.FILENAME + "<a href='" + url + "filedownload?attachSeqNum="+ val.ATTACHSEQNUM +", '_blank', 'EnableViewPortScale=yes' id='manual_file'><img class='fileDown' src='../img/download.png' style='width:1.5em; height:1.5em;'></a>");
//								attachFile();
							}						
						}	
					}
					
					if($.mobile.activePage.attr('id') != 'page_manual_detail'){					
						$('#alarm_beforeManualList').attr('href','alarmList_noti_detail_manual.html?checked='+ val.SERVICEID);
					}else{
						$('#beforeManualList').attr('href','board_manual.html?checked='+ val.SERVICEID);
					}
									
					beforeChecked = val.SERVICEID;
					$.mobile.hidePageLoadingMsg();
			    });	
			}					
		},
		error: function(jqXHR, textStatus, errorThrown) {
			console.log(manualDetail_debugPrefix + "매뉴얼 상세화면 출력 에러 : " + jqXHR.status);
	        console.log(manualDetail_debugPrefix + "매뉴얼 상세화면 출력 에러 : " + jqXHR.responseText);
			console.log(manualDetail_debugPrefix + "매뉴얼 상세화면 출력 에러 : " + errorThrown);
	    }
	}); 
}

//안드로이드 기기 backbutton 이벤트
function onDeviceReady(){
document.addEventListener("backbutton", onBackKeyDown, true);
}

function onBackKeyDown(){
	if($.mobile.activePage.attr('id') == 'page_manual_detail'){
		$.mobile.changePage('board_manual.html?checked=' + beforeChecked);
	}else if($.mobile.activePage.attr('id') == 'page_alarmManual_detail'){
		$.mobile.changePage('alarmList_noti_detail_manual.html?checked=' + beforeChecked);
	}else{
		 navigator.app.backHistory();
	}
}

$(document).on("pagebeforeshow","#page_manual_detail",function(event){
	//showManualDetail();	
}); 
$(document).on("pageshow","#page_manual_detail",function(event){
	showManualDetail();
}); 
$(document).on("pageshow","#page_alarmManual_detail",function(event){
	showManualDetail();
}); 